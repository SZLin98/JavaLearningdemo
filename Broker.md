Broker是这个MQ的存储消息的地方，存储用到的文件主要有：CommitLog文件、ConsumeQueue文件、Index文件。

MQ将所有主题的消息都存储在同一个文件中，确保消息发送时候写文件按顺序写，来尽量保证消息发送时候的高性能。但是按顺序追加在写入的时候方便，读取的时候就麻烦了。

所以为了提高消费的效率，提高检索效率，引入了ConsumeQueue消费队列文件，每个消息主题包含多个消息消费队列，每一个消息队列有一个消息文件。Index索引文件的设计理念是为了加速消息的检索性能，根据消息的属性从CommitLog中快速地检索消息。



1、CommitLog：消息存储的文件，所有消息都存储在commitLog中

2、ConsumeQueue：消息消费队列，消息到达CommitLog后，将异步转发到ConsumeQueue文件中，供消息消费者来消费

3、Index：消息索引，主要存储消息的key跟offset的对应关系



1、MQ存储文件的组织方式

为了追求写入时候的性能，所有主题的消息都会被写入到一个文件，即CommitLog文件中，所有消息按到达的顺序依次追加到coomitLog，一旦写入后不支持修改。

mq为每个commitLog取名就是以该文件的存储的物理偏移量来存储，如第一个文件为0000，第二个文件名为0123。这样做的好处是给出任意一个物理偏移量的话，都可用二分查找来定位文件。然后再用消息偏移量减文件名代表的文件起始位置，就得到了要寻找的偏移量在文件中的绝对位置。



为解决每个topic的消息检索问题，引入了ConsumeQueue文件，文件的构造为：commitlog偏移量（8字节）、大小（4字节）、tag哈希码（8字节）。

consumeQueue文件是消息消费队列文件，是commitLog基于topic的索引文件。组织方式为/topic/queue，同一个队列中存在多个消息文件。

ConsumeQueue的设计每个条目长度固定。

这里的tag存储的不是原始字符串，而是存储消息的tag的哈希码，来确保每个条目的长度固定，可用使用访问类似数字下标的方式快速定位条目，提高consumeQueue文件的读取性能。

消息消费者根据topic、消息消费进度（ConsumeQueue逻辑偏移量），即第几个consumeQueue条目，这样的消费进度去访问消息，通过逻辑偏移量x20，就可用找到该条目的起始偏移量（consumeQueue的物理偏移量）。然后读取该偏移量后面的20个字节就得到了一个条目了，无序遍历consumeQueue文件。



RocketMQ还提供了按消息属性检索消息的能力，引入了Index索引文件。index文件基于物理磁盘实现哈希索引。Index文件由40个字节的文件头、500万个哈希槽、2000万个index条目组成，每个哈希槽4字节、每个index条目20个字节分别是4字节索引key的哈希码、8字节消息物理偏移量、4字节时间戳、4字节的前一个index条目（解决哈希冲突的链表结构）



关键逻辑：

1、CommitLog：消息主体以及元数据的存储主题，存储消息生产后的消息主体内容。消息内容不是定长的。单个文件大小默认是1GB，文件名长度为20位，左边补零，剩余的数字就是起始偏移量。比如00000代表第一个文件，就是起始偏移量是0，文件大小位1G。第二个文件是0001234，起始偏移量是1234，以此类推。消息顺序写入文件，写满了后写下一个文件。

2、Dispatch操作






